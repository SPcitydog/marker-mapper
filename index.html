<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Marker Mapper - A as Origin</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px;
      font-family: monospace;
      z-index: 9999;
      max-width: 90vw;
    }
    pre {
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 50vh;
      overflow: auto;
    }
    #markerImage {
      margin: 5px 0;
      width: 100px;
      height: auto;
      display: none;
      border: 2px solid white;
    }
  </style>
</head>
<body>

  <!-- UI -->
  <div id="ui">
    <div><strong>已掃描 Marker：</strong><span id="lastMarker">無</span></div>
    <img id="markerImage" src="" width="100">
    <div><strong>相對於 Marker A 的座標：</strong></div>
    <pre id="output">{}</pre>
  </div>

  <!-- AR Scene -->
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    vr-mode-ui="enabled: false"
  >
    <a-entity camera></a-entity>

    <!-- Markers -->
    <a-marker type="pattern" url="patterns/marker-a.patt" id="markerA" emitevents="true"></a-marker>
    <a-marker type="pattern" url="patterns/marker-b.patt" id="markerB" emitevents="true"></a-marker>
    <a-marker type="pattern" url="patterns/marker-c.patt" id="markerC" emitevents="true"></a-marker>
    <a-marker type="pattern" url="patterns/marker-d.patt" id="markerD" emitevents="true"></a-marker>
    <a-marker type="pattern" url="patterns/marker-e.patt" id="markerE" emitevents="true"></a-marker>
    <a-marker type="pattern" url="patterns/marker-f.patt" id="markerF" emitevents="true"></a-marker>
  </a-scene>

  <!-- JS Logic -->
  <script>
    const output = document.getElementById("output");
    const lastMarker = document.getElementById("lastMarker");
    const markerImage = document.getElementById("markerImage");

    const worldData = {};
    let markerAWorldMatrix = null;

    // 用於矩陣運算
    const tmpMatrix = new THREE.Matrix4();
    const tmpPosition = new THREE.Vector3();
    const tmpQuaternion = new THREE.Quaternion();
    const tmpScale = new THREE.Vector3();

    const markerIDs = ["A", "B", "C", "D", "E", "F"];

    markerIDs.forEach(letter => {
      const id = `marker${letter}`;
      const marker = document.querySelector(`#${id}`);

      marker.addEventListener("markerFound", () => {
        lastMarker.innerText = `Marker ${letter}`;
        markerImage.src = `images/${letter}.png`;
        markerImage.style.display = "block";

        // 記錄 marker 的世界變換矩陣
        marker.object3D.updateMatrixWorld(true);
        const matrix = marker.object3D.matrixWorld.clone();

        if (letter === "A") {
          markerAWorldMatrix = matrix.clone(); // A 為原點
          worldData["A"] = {
            x: 0,
            y: 0,
            z: 0,
            rotation: { x: 0, y: 0, z: 0 }
          };
        } else if (markerAWorldMatrix) {
          // 轉換為相對於 A 的座標
          tmpMatrix.copy(markerAWorldMatrix).invert();
          matrix.premultiply(tmpMatrix);
          matrix.decompose(tmpPosition, tmpQuaternion, tmpScale);

          const euler = new THREE.Euler().setFromQuaternion(tmpQuaternion, 'XYZ');

          worldData[letter] = {
            x: +tmpPosition.x.toFixed(3),
            y: +tmpPosition.y.toFixed(3),
            z: +tmpPosition.z.toFixed(3),
            rotation: {
              x: +THREE.MathUtils.radToDeg(euler.x).toFixed(1),
              y: +THREE.MathUtils.radToDeg(euler.y).toFixed(1),
              z: +THREE.MathUtils.radToDeg(euler.z).toFixed(1)
            }
          };
        }

        output.innerText = JSON.stringify(worldData, null, 2);
      });
    });
  </script>
</body>
</html>
